<div class="products-page">
  <div class="container">
    <div class="page-header">
      <h1>Каталог товаров</h1>
      <button *ngIf="isAdmin" (click)="addNewProduct()" class="btn-add-product">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Добавить товар
      </button>
    </div>

    <!-- Поиск -->
    <div class="search-section">
      <div class="search-box">
        <input type="text" [(ngModel)]="searchQuery" (input)="onSearchChange($any($event.target).value)"
          placeholder="Поиск товаров..." class="search-input">
        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
      </div>
    </div>

    <!-- Сортировка и фильтры -->
    <div class="controls-section">
      <div class="controls-row">
        <div class="sort-controls">
          <select id="sortBy" [(ngModel)]="sortBy" (change)="onSortChange()" class="select-input compact-select">
            <option value="createdAt">По дате</option>
            <option value="name">По названию</option>
            <option value="price">По цене</option>
            <option value="stock">По наличию</option>
          </select>
          <select [(ngModel)]="sortOrder" (change)="onSortChange()" class="select-input compact-select">
            <option value="DESC">↓</option>
            <option value="ASC">↑</option>
          </select>
        </div>
        <button (click)="showFilters = !showFilters" class="filter-toggle-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
          </svg>
          Фильтры
        </button>
      </div>

      <!-- Панель фильтров -->
      <div class="filters-panel" [class.active]="showFilters">
        <div class="filter-group">
          <label>Цена: {{ priceRangeMin }}₽ - {{ priceRangeMax }}₽</label>
          <div class="price-range-container">
            <div class="dual-range-slider">
              <div class="slider-track" #sliderTrack>
                <div class="slider-progress" [style.left.%]="getMinPercent()" [style.width.%]="getRangePercent()">
                </div>
                <div class="slider-handle slider-handle-min" [style.left.%]="getMinPercent()"
                  (mousedown)="startDrag($event, 'min')" (touchstart)="startDrag($event, 'min')">
                </div>
                <div class="slider-handle slider-handle-max" [style.left.%]="getMaxPercent()"
                  (mousedown)="startDrag($event, 'max')" (touchstart)="startDrag($event, 'max')">
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="filter-group">
          <label>Наличие:</label>
          <select [(ngModel)]="inStock" class="select-input">
            <option [ngValue]="null">Все</option>
            <option [ngValue]="true">В наличии</option>
            <option [ngValue]="false">Нет в наличии</option>
          </select>
        </div>
        <div class="filter-actions">
          <button (click)="applyFilters()" class="apply-filters-btn">Применить</button>
          <button (click)="clearFilters()" class="clear-filters-btn">Сбросить фильтры</button>
        </div>
      </div>
    </div>

    <!-- Категории -->
    <div class="tabs">
      <button (click)="filterByCategory(null)" [class.active]="selectedCategory === null" class="tab-btn">
        Все товары
      </button>
      <button *ngFor="let category of categories" (click)="filterByCategory(category.id)"
        [class.active]="selectedCategory === category.id" class="tab-btn">
        {{ category.name }}
      </button>
    </div>

    <!-- Информация о результатах -->
    <div *ngIf="!loading && !error" class="results-info">
      <p>Найдено товаров: {{ total }}</p>
    </div>

    <div *ngIf="loading && currentPage === 1" class="loading-message">
      <p>Загрузка товаров...</p>
    </div>

    <div *ngIf="error" class="error-message">
      <p>{{ error }}</p>
    </div>

    <div *ngIf="!loading && !error && products.length === 0" class="empty-message">
      <p>Товары не найдены</p>
    </div>

    <div *ngIf="!loading && !error && products.length > 0" class="products-grid">
      <a *ngFor="let product of products" [routerLink]="['/products', product.id]" class="product-card">
        <div class="product-image-wrapper">
          <img
            [src]="(product.images && product.images.length > 0 ? product.images[0] : null) || '/assets/placeholder.svg'"
            [alt]="product.name" (error)="$any($event.target).src='/assets/placeholder.svg'">
          <div *ngIf="product.oldPrice" class="discount-badge">
            -{{ Math.round((1 - product.price / product.oldPrice) * 100) }}%
          </div>
          <div *ngIf="isAdmin" class="admin-actions">
            <button (click)="openEditDrawer(product, $event)" class="edit-icon" aria-label="Редактировать">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
            </button>
            <button (click)="deleteProduct(product.id, $event)" class="delete-icon" aria-label="Удалить">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
              </svg>
            </button>
          </div>
        </div>
        <div class="product-content">
          <h3>{{ product.name }}</h3>
          <p *ngIf="product.description" class="description">{{ product.description | slice:0:100 }}...</p>
          <div class="product-info" *ngIf="product.specifications && product.specifications.length > 0">
            <span *ngFor="let spec of product.specifications" class="info-badge">
              {{ spec.name }}: {{ spec.value }}
            </span>
          </div>
          <div class="price-section">
            <p class="price">
              <span *ngIf="product.oldPrice" class="old-price">{{ product.oldPrice | number }} ₽</span>
              <span class="current-price">{{ product.price | number }} ₽</span>
            </p>
          </div>
          <div class="stock-actions-wrapper">
            <span *ngIf="product.stock >= 1" class="in-stock-badge">В наличии</span>
            <div class="actions" (click)="$event.preventDefault(); $event.stopPropagation();">
              <div *ngIf="!isInCart(product.id) && product.stock > 0" class="cart-button-wrapper">
                <button (click)="addToCart(product.id)" class="btn-cart">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 2L7 6m10 0l-2-4M3 6h18l-1 7H4L3 6zM4 13h16l-1 7H5l-1-7z" />
                    <circle cx="9" cy="20" r="1" />
                    <circle cx="20" cy="20" r="1" />
                  </svg>
                  В корзину
                </button>
              </div>
              <div *ngIf="product.stock === 0" class="cart-button-wrapper">
                <button (click)="openAvailabilityModal(product)" class="btn-cart">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    <line x1="9" y1="10" x2="15" y2="10"></line>
                  </svg>
                  Уточнить о наличии
                </button>
              </div>
              <div *ngIf="isInCart(product.id)" class="quantity-controls-card">
                <button (click)="decreaseQuantity(getCartItem(product.id).id, product.id)">−</button>
                <span>{{ getCartItem(product.id).quantity }}</span>
                <button (click)="increaseQuantity(getCartItem(product.id).id, product.id)"
                  [disabled]="!canIncreaseQuantity(product.id)">+</button>
              </div>
              <button (click)="openInstallmentModal(product.name, product.price)" class="btn-installment">
                Купить в рассрочку
              </button>
            </div>
          </div>
        </div>
      </a>
    </div>

    <!-- Индикатор загрузки дополнительных товаров -->
    <div *ngIf="loadingMore" class="loading-more">
      <p>Загрузка товаров...</p>
    </div>

    <!-- Индикатор конца списка -->
    <div *ngIf="!loadingMore && !hasMore && products.length > 0" class="end-message">
      <p>Все товары загружены</p>
    </div>
  </div>
</div>