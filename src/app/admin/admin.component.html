<div class="admin-page">
  <div class="container">
    <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>

    <div class="tabs">
      <button (click)="setTab('products')" [class.active]="activeTab === 'products'">–¢–æ–≤–∞—Ä—ã</button>
      <button (click)="setTab('news')" [class.active]="activeTab === 'news'">–ù–æ–≤–æ—Å—Ç–∏</button>
      <button (click)="setTab('categories')" [class.active]="activeTab === 'categories'">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
      <button (click)="setTab('settings')" [class.active]="activeTab === 'settings'">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button (click)="setTab('chats')" [class.active]="activeTab === 'chats'">
        –ß–∞—Ç—ã
        <span *ngIf="unreadChatsCount > 0" class="badge">
          {{ unreadChatsCount }}
        </span>
      </button>
    </div>

    <!-- Products Tab -->
    <div *ngIf="activeTab === 'products'" class="tab-content">
      <h2>{{ editingProduct ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä' : '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä' }}</h2>
      <form (ngSubmit)="saveProduct()" enctype="multipart/form-data">
        <input [(ngModel)]="productForm.name" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
        <textarea [(ngModel)]="productForm.description" name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
        <input type="number" [(ngModel)]="productForm.price" name="price" placeholder="–¶–µ–Ω–∞" required>
        <input type="number" [(ngModel)]="productForm.oldPrice" name="oldPrice" placeholder="–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞">

        <div class="image-upload-section">
          <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ (–ø–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –≥–ª–∞–≤–Ω—ã–º):</label>
          <input type="file" #imagesInput multiple (change)="onImagesSelected($event)" accept="image/*">

          <!-- –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (—Ç–µ–∫—É—â–∏–µ + –Ω–æ–≤—ã–µ) —Å drag and drop -->
          <div *ngIf="getAllImages().length > 0" class="images-list" cdkDropList
            (cdkDropListDropped)="onImagesDrop($event)">
            <div *ngFor="let img of getAllImages(); let i = index; trackBy: trackByImage" class="image-item" cdkDrag
              [cdkDragData]="i">
              <div class="drag-handle" cdkDragHandle>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="9" cy="12" r="1" />
                  <circle cx="9" cy="5" r="1" />
                  <circle cx="9" cy="19" r="1" />
                  <circle cx="15" cy="12" r="1" />
                  <circle cx="15" cy="5" r="1" />
                  <circle cx="15" cy="19" r="1" />
                </svg>
              </div>
              <img [src]="img.url" [attr.data-original-src]="img.url" [alt]="'–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ' + (i + 1)"
                (error)="onImageError($event)">
              <div class="image-badge" *ngIf="i === 0">–ì–ª–∞–≤–Ω–æ–µ</div>
              <button type="button" (click)="removeImage(i)" class="remove-image-btn">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        </div>

        <div class="video-upload-section">
          <label>–í–∏–¥–µ–æ:</label>
          <input type="file" #videoInput (change)="onVideoSelected($event)" accept="video/*">
          <div *ngIf="productForm.videoPreview" class="video-preview">
            <label>–ù–æ–≤–æ–µ –≤–∏–¥–µ–æ:</label>
            <video [src]="productForm.videoPreview" controls style="max-width: 300px; max-height: 200px;"></video>
            <button type="button" (click)="clearVideo()">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
          <div *ngIf="editingProduct && productForm.video && !productForm.removedVideo" class="current-video">
            <label>–¢–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ:</label>
            <div class="current-video-wrapper">
              <video [src]="productForm.video" controls style="max-width: 300px; max-height: 200px;"></video>
              <button type="button" (click)="removeCurrentVideo()" class="remove-video-btn">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        </div>

        <input type="number" [(ngModel)]="productForm.stock" name="stock" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" value="0">
        <select [(ngModel)]="productForm.categoryId" name="categoryId" required (change)="onCategoryChange()">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
          <option *ngFor="let cat of categories" [value]="cat.id">{{ cat.name }}</option>
        </select>

        <div class="specifications-section">
          <label>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ç–æ–≤–∞—Ä–∞:</label>
          <div *ngFor="let spec of productForm.specifications; let i = index" class="specification-item">
            <div class="spec-input-group">
              <input type="text" [(ngModel)]="spec.name" [name]="'specName' + i" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏"
                [attr.list]="'specSuggestions' + i" (input)="onSpecNameChange(i)">
              <datalist [attr.id]="'specSuggestions' + i">
                <option *ngFor="let catSpec of categorySpecifications" [value]="catSpec">
              </datalist>
              <input type="text" [(ngModel)]="spec.value" [name]="'specValue' + i" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ">
              <button type="button" (click)="removeSpecification(i)" class="remove-spec-btn">√ó</button>
            </div>
          </div>
          <button type="button" (click)="addSpecification()" class="add-spec-btn">+ –î–æ–±–∞–≤–∏—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É</button>
        </div>
        <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" (click)="resetForms()" *ngIf="editingProduct">–û—Ç–º–µ–Ω–∞</button>
      </form>

      <h2>–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</h2>
      <div class="list">
        <div *ngFor="let product of products" class="list-item product-item">
          <div class="product-info">
            <img
              [src]="(product.images && product.images.length > 0 ? product.images[0] : null) || getPlaceholderImage()"
              [alt]="product.name" class="product-image" (error)="onImageError($event)">
            <div class="product-details">
              <h3>{{ product.name }}</h3>
              <div class="product-meta">
                <span class="price">{{ product.price | number }} ‚ÇΩ</span>
                <span *ngIf="product.oldPrice" class="old-price">{{ product.oldPrice | number }} ‚ÇΩ</span>
                <span class="stock" [class.in-stock]="product.stock > 0" [class.out-of-stock]="product.stock === 0">
                  {{ product.stock > 0 ? '–í –Ω–∞–ª–∏—á–∏–∏ (' + product.stock + ')' : '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏' }}
                </span>
                <span *ngIf="getCategoryName(product.categoryId)" class="category">
                  {{ getCategoryName(product.categoryId) }}
                </span>
              </div>
              <p *ngIf="product.description" class="description">{{ product.description | slice:0:100 }}{{
                product.description.length > 100 ? '...' : '' }}</p>
            </div>
          </div>
          <div class="product-actions">
            <button (click)="editProduct(product)">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button (click)="deleteProduct(product.id)" class="delete">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>

    <!-- News Tab -->
    <div *ngIf="activeTab === 'news'" class="tab-content">
      <h2>{{ editingNews ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å' }}</h2>
      <form (ngSubmit)="saveNews()" enctype="multipart/form-data">
        <input [(ngModel)]="newsForm.title" name="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" required>
        <textarea [(ngModel)]="newsForm.content" name="content" placeholder="–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ" rows="10" required></textarea>

        <div class="image-upload-section">
          <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
          <input type="file" #newsImageInput (change)="onNewsImageSelected($event)" accept="image/*">
          <div *ngIf="newsForm.imagePreview" class="image-preview">
            <img [src]="newsForm.imagePreview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
            <button type="button" (click)="clearNewsImage()">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
          <div *ngIf="editingNews && newsForm.image && !newsForm.imagePreview" class="current-image">
            <label>–¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
            <img [src]="newsForm.image" alt="–¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
          </div>
        </div>

        <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" (click)="resetForms()" *ngIf="editingNews">–û—Ç–º–µ–Ω–∞</button>
      </form>

      <h2>–°–ø–∏—Å–æ–∫ –Ω–æ–≤–æ—Å—Ç–µ–π</h2>
      <div class="list">
        <div *ngFor="let item of news" class="list-item">
          <span>{{ item.title }}</span>
          <div>
            <button (click)="editNews(item)">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button (click)="deleteNews(item.id)" class="delete">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Categories Tab -->
    <div *ngIf="activeTab === 'categories'" class="tab-content">
      <h2>{{ editingCategory ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é' : '–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é' }}</h2>
      <form (ngSubmit)="saveCategory()" enctype="multipart/form-data">
        <input [(ngModel)]="categoryForm.name" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
        <textarea [(ngModel)]="categoryForm.description" name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>

        <div class="image-upload-section">
          <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
          <input type="file" #categoryImageInput (change)="onCategoryImageSelected($event)" accept="image/*">
          <div *ngIf="categoryForm.imagePreview" class="image-preview">
            <img [src]="categoryForm.imagePreview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
            <button type="button" (click)="clearCategoryImage()">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
          <div *ngIf="editingCategory && categoryForm.image && !categoryForm.imagePreview" class="current-image">
            <label>–¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
            <img [src]="categoryForm.image" alt="–¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
          </div>
        </div>

        <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" (click)="resetForms()" *ngIf="editingCategory">–û—Ç–º–µ–Ω–∞</button>
      </form>

      <h2>–°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h2>
      <p class="drag-hint">üí° –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞</p>
      <div class="list" cdkDropList (cdkDropListDropped)="onCategoryDrop($event)">
        <div *ngFor="let category of categories; let i = index" class="list-item draggable-item" cdkDrag
          [cdkDragData]="category">
          <div class="drag-handle" cdkDragHandle>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="9" cy="12" r="1" />
              <circle cx="9" cy="5" r="1" />
              <circle cx="9" cy="19" r="1" />
              <circle cx="15" cy="12" r="1" />
              <circle cx="15" cy="5" r="1" />
              <circle cx="15" cy="19" r="1" />
            </svg>
          </div>
          <div class="category-content">
            <span>{{ category.name }}</span>
            <div class="category-actions">
              <button (click)="editCategory(category)">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button (click)="deleteCategory(category.id)" class="delete">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div *ngIf="activeTab === 'settings'" class="tab-content">
      <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞</h2>

      <div class="settings-section">
        <h3>–§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3>
        <p class="settings-description">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ —Ñ–æ–Ω –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
          —Å–∞–π—Ç–∞</p>

        <form (ngSubmit)="saveBackgroundImage()" enctype="multipart/form-data">
          <div class="image-upload-section">
            <input type="file" #backgroundImageInput (change)="onBackgroundImageSelected($event)" accept="image/*">
            <div *ngIf="backgroundImagePreview" class="image-preview">
              <img [src]="backgroundImagePreview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ–Ω–∞">
              <button type="button" (click)="clearBackgroundImage()">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
            <div *ngIf="currentBackgroundImage && !backgroundImagePreview" class="current-image">
              <label>–¢–µ–∫—É—â–µ–µ —Ñ–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
              <div class="current-image-wrapper">
                <img [src]="currentBackgroundImage" alt="–¢–µ–∫—É—â–∏–π —Ñ–æ–Ω" (error)="onImageError($event)">
                <button type="button" (click)="removeBackgroundImage()" class="remove-image-btn">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            </div>
          </div>
          <button type="submit" class="btn-primary" [disabled]="!backgroundImageFile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
      </div>
    </div>

    <!-- Chats Tab -->
    <div *ngIf="activeTab === 'chats'" class="tab-content chats-tab">
      <div class="chats-layout">
        <div class="chats-list">
          <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã</h2>
          <div *ngIf="chatSessions.length === 0" class="no-chats">
            –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤
          </div>
          <div *ngFor="let session of chatSessions; let i = index" class="chat-session-item"
            [class.active]="selectedChatSession?.id === session.id" [class.unread]="session.hasUnreadMessages"
            (click)="selectChatSession(session)">
            <div class="session-header">
              <strong>–ß–∞—Ç #{{ chatSessions.length - i }}</strong>
              <span *ngIf="session.hasUnreadMessages" class="unread-badge">–ù–æ–≤–æ–µ</span>
            </div>
            <div class="session-info">
              <span *ngIf="session.phone">üìû {{ session.phone }}</span>
              <span class="session-date">{{ session.updatedAt | date:'dd.MM.yyyy, HH:mm' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Fullscreen Chat View -->
      <div class="chat-fullscreen-overlay" *ngIf="selectedChatSession" (click)="closeChatSession()">
        <div class="chat-fullscreen" (click)="$event.stopPropagation()">
          <div class="chat-header">
            <div class="chat-header-content">
              <h3>{{ getChatTitle(selectedChatSession) }}</h3>
              <span *ngIf="selectedChatSession.phone">üìû {{ selectedChatSession.phone }}</span>
            </div>
            <button class="close-chat-btn" (click)="closeChatSession()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
          </div>
          <div class="chat-messages-view" #chatMessagesView>
            <div *ngFor="let msg of chatMessages" class="message" [class.admin]="msg.isAdmin">
              <strong>{{ msg.username }}:</strong> {{ msg.message }}
              <span class="message-time">{{ msg.createdAt | date:'dd.MM.yyyy, HH:mm' }}</span>
            </div>
          </div>
          <div class="chat-input-admin">
            <input [(ngModel)]="adminMessage" (keyup.enter)="sendAdminMessage()" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç...">
            <button (click)="sendAdminMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>