<div class="admin-page">
  <div class="container">
    <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>

    <div class="tabs">
      <button (click)="setTab('categories')" [class.active]="activeTab === 'categories'">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
      <button (click)="setTab('settings')" [class.active]="activeTab === 'settings'">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button (click)="setTab('chats')" [class.active]="activeTab === 'chats'">
        –ß–∞—Ç—ã
        <span *ngIf="unreadChatsCount > 0" class="badge">
          {{ unreadChatsCount }}
        </span>
      </button>
    </div>

    <!-- Categories Tab -->
    <div *ngIf="activeTab === 'categories'" class="tab-content">
      <div class="tab-header">
        <h2>–°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h2>
        <button (click)="addNew('category')" class="btn-add">+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
      </div>
      <!-- –§–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ –¥—Ä–æ–≤–µ—Ä -->
      <p class="drag-hint">üí° –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞</p>
      <div class="list" cdkDropList (cdkDropListDropped)="onCategoryDrop($event)">
        <div *ngFor="let category of categories; let i = index" class="list-item draggable-item" cdkDrag
          [cdkDragData]="category">
          <div class="drag-handle" cdkDragHandle>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="9" cy="12" r="1" />
              <circle cx="9" cy="5" r="1" />
              <circle cx="9" cy="19" r="1" />
              <circle cx="15" cy="12" r="1" />
              <circle cx="15" cy="5" r="1" />
              <circle cx="15" cy="19" r="1" />
            </svg>
          </div>
          <div class="category-content">
            <span>{{ category.name }}</span>
            <div class="category-actions">
              <button (click)="editCategory(category)" class="edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button (click)="deleteCategory(category.id)" class="delete">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div *ngIf="activeTab === 'settings'" class="tab-content">
      <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞</h2>

      <div class="settings-section">
        <h3>–§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3>
        <p class="settings-description">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ —Ñ–æ–Ω –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
          —Å–∞–π—Ç–∞</p>

        <form (ngSubmit)="saveBackgroundImage()" enctype="multipart/form-data">
          <div class="image-upload-section">
            <input type="file" #backgroundImageInput (change)="onBackgroundImageSelected($event)" accept="image/*">
            <div *ngIf="backgroundImagePreview" class="image-preview">
              <img [src]="backgroundImagePreview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ–Ω–∞">
              <button type="button" (click)="clearBackgroundImage()">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
            <div *ngIf="currentBackgroundImage && !backgroundImagePreview" class="current-image">
              <label>–¢–µ–∫—É—â–µ–µ —Ñ–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
              <div class="current-image-wrapper">
                <img [src]="currentBackgroundImage" alt="–¢–µ–∫—É—â–∏–π —Ñ–æ–Ω" (error)="onImageError($event)">
                <button type="button" (click)="removeBackgroundImage()" class="remove-image-btn">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            </div>
          </div>
          <button type="submit" class="btn-primary" [disabled]="!backgroundImageFile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
      </div>
    </div>

    <!-- Chats Tab -->
    <div *ngIf="activeTab === 'chats'" class="tab-content chats-tab">
      <div class="chats-layout">
        <div class="chats-list">
          <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã</h2>
          <div *ngIf="chatSessions.length === 0" class="no-chats">
            –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤
          </div>
          <div *ngFor="let session of chatSessions; let i = index" class="chat-session-item"
            [class.active]="selectedChatSession?.id === session.id" [class.unread]="session.hasUnreadMessages"
            (click)="selectChatSession(session)">
            <div class="session-header">
              <strong>–ß–∞—Ç #{{ chatSessions.length - i }}</strong>
              <span *ngIf="session.hasUnreadMessages" class="unread-badge">–ù–æ–≤–æ–µ</span>
            </div>
            <div class="session-info">
              <span *ngIf="session.phone">üìû {{ session.phone }}</span>
              <span class="session-date">{{ session.updatedAt | date:'dd.MM.yyyy, HH:mm' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Fullscreen Chat View -->
      <div class="chat-fullscreen-overlay" *ngIf="selectedChatSession" (click)="closeChatSession()">
        <div class="chat-fullscreen" (click)="$event.stopPropagation()">
          <div class="chat-header">
            <div class="chat-header-content">
              <h3>{{ getChatTitle(selectedChatSession) }}</h3>
              <span *ngIf="selectedChatSession.phone">üìû {{ selectedChatSession.phone }}</span>
            </div>
            <button class="close-chat-btn" (click)="closeChatSession()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
          </div>
          <div class="chat-messages-view" #chatMessagesView>
            <div *ngFor="let msg of chatMessages" class="message" [class.admin]="msg.isAdmin">
              <strong>{{ msg.username }}:</strong> {{ msg.message }}
              <span class="message-time">{{ msg.createdAt | date:'dd.MM.yyyy, HH:mm' }}</span>
            </div>
          </div>
          <div class="chat-input-admin">
            <input [(ngModel)]="adminMessage" (keyup.enter)="sendAdminMessage()" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç...">
            <button (click)="sendAdminMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>